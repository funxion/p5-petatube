(function(){"use strict";window.PetaTube={Model:{},Collection:{},View:{}},jQuery(function(){var e=window.PetaTube,t=new e.Collection.Videos;new e.View.Search({videos:t}),new e.View.Video({videos:t});var i=window.location.search.match(/\?(https?.+)/);if(i){var n=i[1];t.fetchByUrl(n)}else{var o=new e.Collection.HotPages;new e.View.HotPages({collection:o}),o.fetch()}})})(),function(){"use strict";PetaTube.Model.HotPage=Backbone.Model.extend({petaURL:function(){return"/?"+this.get("url")}})}(),function(){"use strict";PetaTube.Model.Video=Backbone.Model.extend({urlRoot:"/api/video"})}(),function(){"use strict";PetaTube.Collection.HotPages=Backbone.Collection.extend({model:PetaTube.Model.HotPage,fetch:function(){$.ajax({url:"/api/hot",dataType:"json",data:{}}).done($.proxy(function(e){this.reset(e)},this))}})}(),function(){"use strict";PetaTube.Collection.Videos=Backbone.Collection.extend({currentIndex:0,model:PetaTube.Model.Video,fetchByUrl:function(e){$.ajax({url:"/api/page",dataType:"json",data:{url:e}}).done($.proxy(function(e){this.currentIndex=0,this.title=e.title,this.url=e.url,this.reset(e.video_ids),this.trigger("change:title")},this))},current:function(){return this.at(this.currentIndex)},next:function(){++this.currentIndex,this.currentIndex>=this.length&&(this.currentIndex=0)},prev:function(){--this.currentIndex,0>this.currentIndex&&(this.currentIndex=this.length-1)},skip:function(){var e=this.current().id;this.next(),this.remove(e),0!==this.currentIndex&&this.prev()},shufflePlay:function(){this.currentIndex=0,this.reset(this.shuffle())}})}(),function(){"use strict";PetaTube.View.HotPages=Backbone.View.extend({el:"#hot",initialize:function(){this.collection.on("reset",this.draw,this)},draw:function(e){var t=$("<ul>");e.each(function(e){var i=$("<li>"),n=$("<a>").attr("href",e.petaURL()).text(e.get("title")),o=$('<span class="video_count">').text("("+e.get("video_count")+"videos)");i.append(n).append(o),t.append(i)}),this.$el.append(t),this.$el.fadeIn()}})}(),function(){"use strict";PetaTube.View.Search=Backbone.View.extend({el:"#input-url",initialize:function(e){this.videos=e.videos,this.videos.on("change:title",this.showTitle,this)},events:{"submit form":"search"},search:function(){var e=this.$el.find("input[name='url']").val();return e&&(window.location.search=e),!1},showTitle:function(){this.$el.find("#play-url").empty().append($("<span>").text("by ")).append($("<a>").attr("href",this.videos.url).text(this.videos.title)).append($('<span class="video_count">').text("("+this.videos.length+"videos)"))}})}(),function(){"use strict";PetaTube.View.Video=Backbone.View.extend({player:null,el:"#play-video",initialize:function(e){this.videos=e.videos,this.videos.on("reset",this.play,this)},events:{"click #prev-button":"prev","click #next-button":"next","click #shuffle-button":"shuffle"},next:function(){this.videos.next(),this.play()},prev:function(){this.videos.prev(),this.play()},skip:function(){this.videos.skip(),this.play()},shuffle:function(){this.videos.shufflePlay()},play:function(){var e=this.videos.current();e.get("title")?(this.$el.find("#video-info").text(e.get("title")),$("title").text(e.get("title")+"(PetaTube)")):e.fetch({success:$.proxy(function(){this.$el.find("#video-info").text(e.get("title")),$("title").text(e.get("title")+"(PetaTube)")},this)}),this.loadPlayer();var t=$("#tmpl-button").html(),i=_.template(t,{current:this.videos.currentIndex+1,total:this.videos.length});this.$el.find("#video-panel").html(i)},loadPlayer:function(){var e=this.videos.current();if(this.player)return this.player.loadVideoById(e.id);var t=document.createElement("script");t.src="//www.youtube.com/iframe_api";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(t,i),window.onYouTubeIframeAPIReady=$.proxy(function(){this.player=new YT.Player("video",{height:"450",width:"800",videoId:e.id,events:{onReady:function(){},onStateChange:$.proxy(function(e){var t=e.data;t===YT.PlayerState.ENDED&&this.next()},this),onError:$.proxy(function(){this.skip()},this)}})},this)}})}();